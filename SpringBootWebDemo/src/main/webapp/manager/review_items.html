<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>审核项目</title>
	<link rel="stylesheet" href="../public/css/reset.css">
	<link rel="stylesheet" href="../public/css/myproject.css">

	<link rel="stylesheet" href="/css/bootstrap.min.css">
	<script src="/js/jquery.min.js"></script>
	<script src="/js/bootstrap.min.js"></script>
	<script type="application/javascript" src="/js/jquery.cookie.js"></script>
	<script type="application/javascript" src="/js/ajaxfileupload.js"></script>


</head>
<body>
	<header>
		<div class="header-top-bar">

			<div class="container">
				<nav>
					<ul class="nav-ul">
						<li class="pull-left"><a href="index.html">首页</a></li>
						<li class="pull-left"><a href="policy.html">科技时政</a></li>
						<li class="pull-left"><a href="notice.html">通知公告</a></li>
						<li class="pull-left"><a href="achievements.html">科研成果</a></li>
						<li class="pull-left"><a href="##">科研项目</a></li>
						<li class="pull-left"><a href="info.html">了解我们</a></li>
					</ul>
				</nav>
				<div class="pull-right log" id="log">
					<span>管理员：</span><a href="javascript:;" id="name"></a><img src="../public/images/sanjiao.png" alt="">

					<div class="box" id="box">
						<ul>
							<li><a href="report.html">申报项目</a></li>
							<li><a href="myproject.html">我的科研项目</a></li>
							<li><span></span></li>
							<li><a href="user_manager.html">用户管理</a></li>
							<li><a href="##">审核项目</a></li>
							<li><a href="platform_manager.html">平台内容管理</a></li>
							<li><span></span></li>
							<li><a href="#" onclick="showUpdateUser()">修改密码</a></li>
							<li><a href="/login.html">注销</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
		<div class="head">
			<div class="container">
				<div class="head-title"><p>项目审核</p></div>
			</div>
		</div>
	</header><!-- header end -->

	<div class="content container">
		<div class="position">
			<span>位置></span>
			<a href="">申报项目审核</a>
		</div>
		<form action="#" class="search">
	        <div class="form-group">
	          <!-- <input type="text" class="form-control pull-left" placeholder="按条件查询..."> -->
	          <input list="conditions" id="condition" name="condition" class="condition pull-left" placeholder="按条件查询...">
	          <datalist id="conditions">
			  	<option value="未通过">
				  <option value="审核通过">
			</datalist>
	        </div>
	        <button type="button" onclick="getProjects()" class="btn">查询</button>
		</form>
	</div><!-- header end -->

	<div class="content-table container">
		<table class="table" id="table" >
			<thead>
				<tr>
					<th>序号</th>
					<th>项目名</th>
					<th>申报时间</th>
					<th>申报者</th>
					<th>审核状态</th>
					<th>操作</th>
				</tr>
			</thead>
			<tbody id="tbody">
				<tr>
					<td></td>
					<td>ＳＡＤＦＡＳＤＡＳＳＡ</td>
					<td>2016-12-13</td>
					<td>李三</td>
					<td>未审核</td>
					<td>

						<a href="review.html" class="btn review">审核</a>

					</td>
				</tr>

			</tbody>
		</table>
		<div class="paging" id="paging">

		</div>
	</div>


	<footer>

		<!-- 按钮触发模态框 -->
		<button class="btn btn-primary btn-lg" style="display: none;" id="search_user_update_modal" data-toggle="modal" data-target="#updateUserModal"></button>
		<div class="modal fade" id="updateUserModal" tabindex="-1" role="dialog" aria-labelledby="UserModal" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						<h4 class="modal-title" id="updateUserModalLabel">修改密码</h4>
					</div>

					<div class="modal-body">
						<form role="form" id=""
							  action="">

							<div class="form-group">
								<label>新密码:</label>
								<div>
									<input type="password" class="form-control" id="research_user_update_old_password"
										   value=""  placeholder="请输入你的密码">
								</div>
							</div>
							<div class="form-group">
								<label>再输一次:</label>
								<div>
									<input type="password" id="research_user_update_new_password" name="password" class="form-control"
										   value=""  placeholder="请输入你的密码">
								</div>
							</div>

						</form>

					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
						<button type="button" class="btn btn-primary" onclick="updateUserById()">提交更改</button>
					</div>

				</div><!-- /.modal-content -->
			</div><!-- /.modal -->
		</div>



		<div class="href-1 ">
				<p>友情链接</p>
			</div>
			<div class="foot-1">

			</div>
	</footer><!-- footers end -->

	<script>
		document.write( "<script language=javascript src='../public/js/box.js'><\/script>");

		document.write( "<script language=javascript src='../public/js/paging.js'><\/script>");
		window.onload=function(){
			$("#name").text($.cookie("user_name"));
			getProjects();

		}


		function initPages() {
			$("#paging").empty();

			var tbody=document.getElementById('tbody');
			var atr=tbody.getElementsByTagName('tr');
			var pages=Math.ceil(atr.length/12);

			var paging=document.getElementById('paging');
			for(var i=0;i<atr.length;i++){
				atr[i].firstElementChild.innerHTML=i+1;

			}

			//分页，添加页码
			for(var i=1;i<=pages;i++){

				// a[0].style.backgroundColor="";
				// a[0].style.color="#252525";

				if(pages>6){

					for(var i=1;i<=5;i++){
						var nodeA=document.createElement("a");
						var textNode=document.createTextNode(i);
						nodeA.appendChild(textNode);
						paging.appendChild(nodeA);

					}

					var a=paging.getElementsByTagName('a');
					a[0].style.backgroundColor="#fa3e3e";
					a[0].style.color="#ffffff";


					var nodeS=document.createElement("span");
					var ellipsis=document.createTextNode('...');
					nodeS.appendChild(ellipsis);
					paging.appendChild(nodeS);

					var nodeAEnd=document.createElement("a");
					var textEnd=document.createTextNode(pages);
					nodeAEnd.appendChild(textEnd);
					paging.appendChild(nodeAEnd);
					break;
				}
				if(pages<=6){
					for(var i=1;i<=pages;i++){
						var nodeA=document.createElement("a");
						var textNode=document.createTextNode(i);
						nodeA.appendChild(textNode);
						paging.appendChild(nodeA);

					}
					var a=paging.getElementsByTagName('a');
					a[0].style.backgroundColor="#fa3e3e";
					a[0].style.color="#ffffff";
					for(var i=12;i<atr.length;i++){
						atr[i].style.display='none';
					}

				}
			}

			function page(){
				var a=paging.getElementsByTagName("a");

				for(var j=0;j<a.length;j++){

					a[j].onclick=function(){
						var num=parseInt(this.innerHTML);
						if(num<=5){
							if(pages>6){
								paging.innerHTML='';
								var num=parseInt(num);
								for(var i=1;i<=5;i++){
									var nodeA=document.createElement("a");
									var textNode=document.createTextNode(i);
									nodeA.appendChild(textNode);
									paging.appendChild(nodeA);
								}
								var nodeS=document.createElement("span");
								var ellipsis=document.createTextNode('...');
								nodeS.appendChild(ellipsis);
								paging.appendChild(nodeS);

								var nodeAEnd=document.createElement("a");
								var textEnd=document.createTextNode(pages);
								nodeAEnd.appendChild(textEnd);
								paging.appendChild(nodeAEnd);


								var index=parseInt(num-1);
								a[index].style.backgroundColor="#fa3e3e";
								a[index].style.color="#ffffff";
							}
							else{
								for(var i=0;i<a.length;i++){
									a[i].style.backgroundColor="";
									a[i].style.color="#252525";
								}
								var index=parseInt(num-1);
								a[index].style.backgroundColor="#fa3e3e";
								a[index].style.color="#ffffff";
							}

						}
						if(num>=5&&num<=pages-5){
							paging.innerHTML='';
							var nodeAFirst=document.createElement('a');
							var textFirst=document.createTextNode('1');
							nodeAFirst.appendChild(textFirst);
							paging.appendChild(nodeAFirst);


							var nodeS=document.createElement("span");
							var ellipsis=document.createTextNode('...');
							nodeS.appendChild(ellipsis);
							paging.appendChild(nodeS);



							for(var i=num-2;i<=num+2;i++){
								var nodeA=document.createElement("a");
								var textNode=document.createTextNode(i);
								nodeA.appendChild(textNode);
								paging.appendChild(nodeA);
							}

							var nodeS=document.createElement("span");
							var ellipsis=document.createTextNode('...');
							nodeS.appendChild(ellipsis);
							paging.appendChild(nodeS);

							var nodeAEnd=document.createElement("a");
							var textEnd=document.createTextNode(pages);
							nodeAEnd.appendChild(textEnd);
							paging.appendChild(nodeAEnd);

							a[3].style.backgroundColor="#fa3e3e";
							a[3].style.color="#ffffff";
						}

						if(num>pages-5){
							if(pages>6){
								paging.innerHTML='';
								var nodeAFirst=document.createElement('a');
								var textFirst=document.createTextNode('1');
								nodeAFirst.appendChild(textFirst);
								paging.appendChild(nodeAFirst);


								var nodeS=document.createElement("span");
								var ellipsis=document.createTextNode('...');
								nodeS.appendChild(ellipsis);
								paging.appendChild(nodeS);


								for(var i=num-5+pages-num;i<=pages;i++){
									var nodeA=document.createElement("a");
									var textNode=document.createTextNode(i);
									nodeA.appendChild(textNode);
									paging.appendChild(nodeA);
								}

								var index=parseInt(num-1);
								a[7-pages+index].style.backgroundColor="#fa3e3e";
								a[7-pages+index].style.color="#ffffff";
							}
							if(num==6){
								for(var i=0;i<a.length;i++){
									a[i].style.backgroundColor="";
									a[i].style.color="#252525";
								}

								a[5].style.backgroundColor="#fa3e3e";
								a[5].style.color="#ffffff";
							}
						}
						numTr=atr.length;
						if(num===1){
							for(var i=(num-1)*12;i<num*12;i++){

								atr[i].style.display='table-row';

							}
							for(var i=12;i<numTr;i++){
								atr[i].style.display='none';

							}
						}
						if(num>1&&num<numTr){
							for(var i=0;i<(num-1)*12;i++){
								atr[i].style.display='none';

							}
							for(var i=(num-1)*12;i<num*12;i++){

								atr[i].style.display='table-row';


							}
							for(var i=num*12;i<numTr;i++){
								atr[i].style.display='none';

							}
						}
						if(num===pages){
							for(var i=0;i<(num-1)*12;i++){
								atr[i].style.display='none';

							}
							for(var i=(num-1)*12;i<numTr;i++){
								atr[i].style.display='table-row';

							}
						}
						page();
					}

				}
			}
			page();
		}


		function getProjects(){

			var conditions = $("#condition").val();

			if(conditions == "未通过") {
				conditions = "unpass";
			}
			else if(conditions == "审核通过") {
				conditions = "pass";
			}
			else if(conditions == "最近一月") {
				conditions = "recent";
			} else {
				conditions = "all"
			}

			var url = "/project/queryAll"

			$("#tbody").empty();

			$.get(url,{conditions:conditions},function(data) {
				if(data != null) {

					var str = "";
					for(var i=0;i<data.length;i++) {
						str += "<tr><td></td><td>"+data[i].title+"</td><td>"+UnixToDate(data[i].declareTime)+"</td><td>"+data[i].applicant+"</td><td>"+data[i].auditState+"</td><td><button class='edit' onclick=getProjectById("+data[i].id+")>审核</button></td></tr>";
					}
					if(str.length > 0) {
						$("#tbody").append(str);
						initPages();
					}else {
						$("#paging").empty();
					}

				} else {
					alert("error!")
				}
			});
		}

		function getProjectById(id){
			var url="/project/"+id+"/";
			$.get(url, function(data) {
				if(data != null) {

					$.cookie("project_id",data.id);
					$.cookie("project_title",data.title);
					$.cookie("project_applicant",data.applicant);
					$.cookie("project_auditState",data.auditState);
					$.cookie("project_declareUnits",data.declareUnits);
					$.cookie("project_summary",data.summary);
					$.cookie("project_remark",data.remark);
					$.cookie("project_projectFile",data.projectFile);
					$.cookie("project_declareTime",UnixToDate(data.declareTime));
					$.cookie("project_lastUpdated",UnixToDate(data.lastUpdated));
					$.cookie("project_createdDate",UnixToDate(data.createdDate));
					window.location.href = "review.html";
				} else {
					alert("该项目不存在");

					window.location.href = "review_items.html";
				}
			});



		}

		function updateProjectById(){
			var id = $("#research_project_update_id").val();
			var title =$("#research_project_update_title").val();
			var summary = $("#research_project_update_summary").val();
			var applicant = $("#research_project_update_applicant").val();
			var declareUnits = $("#research_project_update_declare_units").val();
			var remark = $("#research_project_update_remark").val();
			var filename = $("#research_project_update_projectFile").val();


			if(filename == null || filename.length == 0 || id == null || id.length == 0 || title == null || title.length == 0 || summary == null || summary.length == 0 || applicant == null || applicant.length == 0
					|| declareUnits == null || declareUnits.length == 0 || remark == null || remark.length == 0) {
				alert("所输入参数不能为空!");
			} else {
				$.ajaxFileUpload({
							url:'http://127.0.0.1/project/update?id='+id+'&title='+title+'&summary='+summary+'&applicant='+applicant+'&declareUnits='+declareUnits+'&remark='+remark,
							type:'POST',
							secureuri: false, //是否需要安全协议，一般设置为false
							dataType: 'json', //返回值类型 一般设置为json
							fileElementId:'research_project_update_projectFile',
							success: function (data){
								if(data != null) {
									alert("修改成功!")
									location.href="logged/myproject.html";
								} else {
									alert("修改失败!")
								}
							},
							error: function (data, status, e)//服务器响应失败处理函数
							{
								alert("error!");
							}

						}
				);
				if(filename == null || filename.length == 0 || id == null || id.length == 0 || title == null || title.length == 0 || summary == null || summary.length == 0 || applicant == null || applicant.length == 0
						|| declareUnits == null || declareUnits.length == 0 || remark == null || remark.length == 0) {

				} else {
					alert("修改成功!")
					location.href="myproject.html";
				}
			}
		}

		function deleteProjectById(id){
			var url="/project/delete";
			$.post(url,{id:id}, function(data) {
				if(data != null) {

					getProjects();

				} else {
					alert("该项目不存在");

					window.location.href = "myproject.html";
				}
			});
		}

		function showUpdateUser(){
			$("#search_user_update_modal").click();
		}

		function updateUserById(){
			var id = $.cookie("user_id")
			var oldPassword = $("#research_user_update_old_password").val();
			var newPassword = $("#research_user_update_new_password").val();
			if(oldPassword != newPassword) {
				alert("两次输入密码不一致!")
			} else {
				var url="/user/update";
				$.post(url,{id:id, password:newPassword}, function(data) {
					if(data != null) {

						window.location.href = "review_items.html";

					} else {
						alert("该项目不存在");

						window.location.href = "review_items.html";
					}
				});
			}
		}

		/**
		 * @return {string}
		 */
		function UnixToDate(unixTime) {
			var time = new Date(unixTime);
			var ymdhis = "";
			ymdhis += time.getUTCFullYear() + "-";
			ymdhis += (time.getUTCMonth()+1) + "-";
			ymdhis += time.getUTCDate();

			ymdhis += " " + time.getUTCHours() + ":";
			ymdhis += time.getUTCMinutes() + ":";
			ymdhis += time.getUTCSeconds();
			return ymdhis;
		}


	</script>
</body>
</html>